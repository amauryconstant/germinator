stages:
  - build-ci
  - setup
  - lint
  - test
  - release
  - mirror

# --------------------------------
# Pipeline rules
# --------------------------------
workflow:
  rules:
    # Merge request pipelines
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    # Main branch pushes
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    # Tag pushes (for releases)
    - if: '$CI_COMMIT_TAG'
    # Everything else disabled
    - when: never

# --------------------------------
# Build CI Docker Image
# --------------------------------
build-ci-image:
  stage: build-ci
  image: docker:24.0.5-cli
  services:
    - docker:24.0.5-dind
  rules:
    - changes:
        - Dockerfile.ci
        - .mise/config.toml
  variables:
    CI_REGISTRY: registry.gitlab.com
    CI_REGISTRY_IMAGE: $CI_REGISTRY/amoconst/germinator/ci
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
  script:
    - MISE_VERSION=$(grep "mise" .mise/config.toml | grep -oP 'mise = "\K[^"]+')
    - docker build -t $CI_REGISTRY_IMAGE:latest -t $CI_REGISTRY_IMAGE:$MISE_VERSION -f Dockerfile.ci .
    - docker push $CI_REGISTRY_IMAGE:latest
    - docker push $CI_REGISTRY_IMAGE:$MISE_VERSION

# --------------------------------
# Defaults
# --------------------------------
default:
  image: registry.gitlab.com/amoconst/germinator/ci:latest
  cache:
    key:
      files:
        - go.mod
        - go.sum
    paths:
      - .cache/go-mod/
    policy: pull-push

# --------------------------------
# Setup (dependency resolution)
# --------------------------------
setup:
  stage: setup
  script:
    - go mod download
  variables:
    GOMODCACHE: "$CI_PROJECT_DIR/.cache/go-mod"
  artifacts:
    paths:
      - .cache/go-mod/
    expire_in: 2 hours

# --------------------------------
# Linting
# --------------------------------
lint:
  stage: lint
  needs: [setup]
  script:
    - golangci-lint run

# --------------------------------
# Tests
# --------------------------------
test:
  stage: test
  needs: [setup]
  script:
    - go test ./... -v

# --------------------------------
# Release with GoReleaser
# --------------------------------
release:
  stage: release
  image: registry.gitlab.com/amoconst/germinator/ci:latest
  needs: [lint, test]
  services:
    - docker:dind
  variables:
    GITLAB_TOKEN: $CI_JOB_TOKEN
  before_script:
    - echo $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin registry.gitlab.com
  script:
    - goreleaser release --clean
  rules:
    - if: '$CI_COMMIT_TAG'

# --------------------------------
# Mirror to GitHub
# --------------------------------
mirror-to-github:
  stage: mirror
  image: alpine:latest
  before_script:
    - apk add --no-cache git
    - |
      if [ -z "$GITHUB_ACCESS_TOKEN" ]; then
        echo "WARNING: GITHUB_ACCESS_TOKEN is not set, skipping GitHub mirror"
        exit 0
      fi
  script:
    - git remote add github "https://${GITHUB_ACCESS_TOKEN}@github.com/${GITHUB_REPO_URL}.git"
    - git fetch github
    - git push github HEAD:$CI_COMMIT_BRANCH --force-with-lease --tags
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
